---
title: add sessin queue
status: done
priority: high
---

# Description

Sessions are used to structure agentic coding data and make it useful, especially for collaboration and building UIs on top of it.

```bash
kanbatte session queue -p project-name 'hey coding agent. Create a task to do ...'
kanbatte session queue -p project-name 'hey coding agent. Start working on task TASK-001'
kanbatte session queue -p project-name 'hey coding agent. Create a task to do ...'
# Returns the session ID
```

A session ID will be auto-generated by the server.

**Note:** This is not interactive. It makes a call to the backend/database and closes immediately. It creates a session that is waiting to be picked up. A separate process (local or on server) with access to coding agents will see the pending session and pick it up for the agent to work on. While the agent is working, it will update the progress by updating the content and status.

#### Session Data Structure

```js
session.id
session.project
session.messages
session.status
session.createdAt
session.updatedAt
```

#### Session Status Values

- `ready`: Initial status
- `in-progress`: Agent has started working on the session
- `review`: Agent has finished working and needs a person to review
- `done`: Person verifies all is good and marks as done

Sessions created via `kanbatte session queue` should have default status of `ready`.

### Viewing Sessions

```bash
# View a specific session (prints in markdown format)
kanbatte session view 'session id'

# View with pager
kanbatte session view 'session id' | less
```

**Implementation Note:** Sessions should be implemented using [eventLog](../../../docs/eventLog.md).

You need to first check the existing session creation logic in src/sessionCommands.js, and modify the parameters and logic to conform to the CLI specifications provided above.

```bash
# List sessions (outputs a table with columns: session id, status, first sentence, last sentence, start date, last update date)
kanbatte session list -p project-name

# Filter sessions by status
kanbatte session list -p project-name -s 'ready,in-progress'
```

# Acceptance Criteria

- [x] Create some sessions using `kanbatte session queue`. 
- [x] After creation, use the returned session IDs to run `kanbatte session view 'session id'` and verify that the session information is displayed correctly.
- [ ] Run `kanbatte session list -p project-name` to see if this can work correctly.

# Implement Plan

1. **Analyze existing session implementation** âœ… COMPLETE
   - **Current state**: `src/sessionCommands.js:addSession()` already implements queue functionality using eventLog pattern
   - **Session data structure** already includes: id, project, messages, status (`ready`), createdAt, updatedAt (lines 21-33)
   - **CLI interface**: `src/cli.js:121-156` already has `session queue` command with `-p` and `-m` options
   - **eventLog system**: Already implemented using `libsqlDao.appendEvent()` and `computeAndSaveView()`

2. **Verify session view command functionality**
   - **Check existing implementation**: `src/sessionCommands.js:readSession()` (lines 107-122) already handles session viewing
   - **CLI integration**: `src/cli.js:228-244` already implements `session view` command with format options
   - **Required changes**: Update `readSession()` to default to markdown format instead of table

3. **Modify session view command for markdown output**
   - **File**: `src/sessionCommands.js`
   - **Function**: `readSession()` (lines 107-122)
   - **Changes needed**:
     - Add markdown formatting logic for session data
     - Format messages array as chat-style markdown
     - Display session metadata (id, project, status, timestamps)
   - **Code modification**:
     ```javascript
     // Add markdown formatting helper
     const formatSessionAsMarkdown = (sessionData) => {
       let output = `# Session ${sessionData.id}\n\n`;
       output += `**Project:** ${sessionData.project}\n`;
       output += `**Status:** ${sessionData.status}\n`;
       output += `**Created:** ${new Date(sessionData.createdAt).toISOString()}\n`;
       output += `**Updated:** ${new Date(sessionData.updatedAt).toISOString()}\n\n`;
       output += `## Messages\n\n`;

       sessionData.messages.forEach(msg => {
         const role = msg.role === 'user' ? 'ðŸ‘¤ User' : 'ðŸ¤– Assistant';
         const timestamp = new Date(msg.timestamp).toISOString();
         output += `### ${role} (${timestamp})\n\n`;
         output += `${msg.content}\n\n`;
       });

       return output;
     };
     ```

4. **Update CLI to handle positional arguments for queue command**
   - **File**: `src/cli.js`
   - **Current**: Lines 121-156 require `-p` and `-m` options
   - **Required change**: Support positional message argument while keeping `-p` option
   - **Code modification**:
     ```javascript
     // Change from:
     .requiredOption("-m, --message <message>", "Initial message content")
     // To:
     .argument("<message>", "Initial message content")
     .requiredOption("-p, --project <projectId>", "Project ID")
     ```

5. **Update sessionCommands.js addSession function**
   - **File**: `src/sessionCommands.js`
   - **Function**: `addSession()` (lines 1-48)
   - **Changes needed**:
     - Modify error message from "use -m or --message" to "provide message as argument"
     - Update validation to check `payload.message` from positional argument instead of option

6. **Add markdown output format support**
   - **File**: `src/utils/output.js`
   - **Function**: Add markdown formatting for sessions
   - **Implementation**:
     ```javascript
     export const formatSessionMarkdown = (sessionData) => {
       // Same markdown formatting logic as above
     };
     ```

7. **Testing and validation**
   - **Test queue command**: `kanbatte session queue -p test-project "Create a task to do something"`
   - **Test view command**: `kanbatte session view <session-id>` (should output markdown by default)
   - **Test view with pager**: `kanbatte session view <session-id> | less`
   - **Verify data structure**: Ensure session has required fields (id, project, messages, status, timestamps)

8. **Implement and enhance session list functionality**
   - **Current state**: `src/cli.js:208-226` already has `session list` command
   - **Required features**:
     - Display table with columns: session id, status, first sentence, last sentence, start date, last update date
     - Support status filtering with `-s` option
   - **Files to modify**:
     - `src/utils/output.js`: Update session list formatting in table mode
     - Ensure first/last sentence extraction from messages array
   - **Implementation details**:
     ```javascript
     // Extract first and last sentences from messages
     const extractSentence = (content) => {
       return content.split(/[.!?]/)[0].trim() + (content.includes('.') ? '.' : '');
     };

     // Update table output format for sessions
     // Columns: Session ID | Status | First Message | Last Message | Start Date | Last Update
     ```

9. **Testing and validation**
   - **Test queue command**: `kanbatte session queue -p test-project "Create a task to do something"`
   - **Test view command**: `kanbatte session view <session-id>` (should output markdown by default)
   - **Test view with pager**: `kanbatte session view <session-id> | less`
   - **Test list command**: `kanbatte session list -p test-project`
   - **Test list with status filter**: `kanbatte session list -p test-project -s 'ready,in-progress'`
   - **Verify data structure**: Ensure session has required fields (id, project, messages, status, timestamps)

10. **Documentation updates**
    - No documentation changes needed - current examples already match desired CLI pattern