
# Kanbatte CLI API

Kanbatte is a task management system for AI agents.

There are 2 core concepts: **tasks** and **sessions**.

**Tasks** are stored in git under the tasks folder. They are numbered tasks, and each task is a markdown file.

**Sessions** represent interactions with AI agents. Each session can create a task, implement a task, or perform any other action (tasks are not required). Session data is stored against a database/server for collaboration, or can be hosted locally if collaboration is not needed.

Follow (DEVELOPMENT.md)[../DEVELOPMENT.md] for technical requirements

## Tasks

Tasks are organized in the structure below. Every repository will have a tasks folder.

### Design Considerations

- Tasks are grouped into folders (000, 100, 200, ..., 1000, 1100, etc.) so each folder can hold 100 tasks. This makes navigation easier for larger projects.
- Tasks start as TASK-001.md instead of TASK-1.md for consistent sorting. Folder sorting will break at folder 1000, but this is acceptable as it's a rare occurrence and folders are few in number.

### Task Types

Tasks have configurable types. Users can specify any type they want: TASK, FEAT, BUG, etc.

### Folder Structure

```
tasks/TASK/
    000/
      TASK-001.md
      TASK-002.md
      ...
      TASK-099.md
    100/
      TASK-100.md
      TASK-101.md
      ...
      TASK-199.md
    200/
      TASK-200.md
tasks/FEAT/
    000/
      FEAT-001.md
      FEAT-002.md
tasks/BUG/
    000/
      BUG-001.md
      BUG-002.md
```

### Task File Format

Example task file content:

```md
---
title: Task Title
status: todo
priority: low
---

# Description

Description ...

# More sections

...

```

Everything below the description is freeform. You can add more sections as needed.

**Status:** Can only be `todo` or `done`. We don't store `in-progress` because that is managed by the session itself.

**Priority:** Can be `low`, `medium`, or `high`.

Additional fields (such as assignee) may be added in the future.


### Tasks CLI

#### Creating Tasks

Create a new task with inline parameters:
```bash
kanbatte task create TASK -t 'title of the task' -d 'task description' -p 'high'
# Creates file in the correct folder with correct content

kanbatte task create TASK --title 'title of the task' --description 'task description' --priority 'high'
```

**Required:** Task type (positional argument) and title (`-t` / `--title`) are required.

**Optional:** Description (`-d` / `--description`) and priority (`-p` / `--priority`) are optional.

For task creation, the system needs to look at existing folders and files to get the latest ID, then create a new task file with the correct ID.


#### Listing Tasks

List tasks as a table (only one format supported for now):

```bash


kanbatte task list
# list all tasks

kanbatte task list TASK
# Prints a table with columns: taskId, status, title

kanbatte task list TASK -s 'todo'
# Filter by status

kanbatte task list TASK -s 'todo' -p 'high,medium'
# Filter by status and priority
```

#### Updating Tasks

Tasks are updated by editing the file content manually. This approach is much simpler.

```bash
kanbatte task locate TASK-001
# Convenience method that returns the relative path of the task: ./tasks/TASK/000/TASK-001.md
# For example: kanbatte task locate TASK-001 | xargs vim
```




## Sessions

**Important:** Projects are completely unrelated to task types. Each session needs to be attached to a project because the project contains the git repository information.

### Managing Projects

```bash
# Create a project
kanbatte session project create -p project-name -r git@github.com:example/example.git -d description
kanbatte session project create --project project-name --repository git@github.com:example/example.git --description description

# Update a project
kanbatte session project update -p project-name -r git@github.com:example/example.git -d description

# List projects (shows table with columns: project-name, repository, description)
kanbatte session project list
```


### Session Queue

Sessions are used to structure agentic coding data and make it useful, especially for collaboration and building UIs on top of it.

```bash
kanbatte session queue -p project-name 'hey coding agent. Create a task to do ...'
kanbatte session queue -p project-name 'hey coding agent. Start working on task TASK-001'
kanbatte session queue -p project-name 'hey coding agent. Create a task to do ...'
# Returns the session ID
```

A session ID will be auto-generated by the server.

**Note:** This is not interactive. It makes a call to the backend/database and closes immediately. It creates a session that is waiting to be picked up. A separate process (local or on server) with access to coding agents will see the pending session and pick it up for the agent to work on. While the agent is working, it will update the progress by updating the content and status.


### Commands for Agents

```bash
kanbatte session append 'session id' -m '[{...}]'
# The JSON will be in the completion API messages format
```

This command is used by both users and agents. Developers will use this API to send additional messages.

```bash
kanbatte session append 'session id' -t -m '[{...}]'
kanbatte session append 'session id' --stop --messages '[{...}]'
```

The `--stop` option tells the agent to stop working and resume immediately, so it will pick up the last message sent by the user.

#### Completion API Format

Below is an example of the completion API format:

```json
{
  "messages": [
    {
      "role": "system",
      "content": "You are a friendly assistant who explains things clearly."
    },
    {
      "role": "user",
      "content": "Explain quantum entanglement in simple terms."
    },
    {
      "role": "assistant",
      "content": "Quantum entanglement is when two particles become linked, so that the state of one instantly affects the other, no matter the distance between them."
    },
    {
      "role": "user",
      "content": "Can you give a real-world analogy?"
    }
  ],
}
```

### Session Status

```bash
kanbatte session status 'session id' 'in-progress'
# Updates the status of the session

kanbatte session status 'session id'
# Returns the current status
```

#### Session Data Structure

```js
session.id
session.project
session.messages
session.status
session.createdAt
session.updatedAt
```

#### Session Status Values

- `ready`: Initial status
- `in-progress`: Agent has started working on the session
- `review`: Agent has finished working and needs a person to review
- `done`: Person verifies all is good and marks as done



### Viewing Sessions

```bash
# List sessions (outputs a table with columns: session id, status, first sentence, last sentence, start date, last update date)
kanbatte session list -p project-name

# Filter sessions by status
kanbatte session list -p project-name -s 'ready,in-progress'

# View a specific session (prints in markdown format)
kanbatte session view 'session id'

# View with pager
kanbatte session view 'session id' | less
```

**Implementation Note:** Sessions should be implemented using [eventLog](./eventLog.md). Remove all previous unnecessary features like comments, followups, etc.



## Server

Finally, this command runs on the server side and spawns an agent to work on sessions:

```bash
kanbatte agent start
```

### Agent Process Flow

The agent runs in a continuous loop:

1. Check for all sessions with `ready` status
2. Pick the first session:
   - Ensure the repository is downloaded in the `./repositories` folder
   - Create a git worktree with the session ID as the branch name
   - Start the coding agent within this worktree:
     - Set session status to `in-progress`
     - Listen to all updates from the agent and send them to the database (same behavior as `kanbatte session append`)
     - Once done, set session status to `review`

### Db setup

Create db tables. is kind of already impletented.

```bash
kanbatte db setup
```



## Migration from current version

- rename task to session
- remove comments and followups
- can keep projects, but need to update the cli
- can keep current folder and files structure


